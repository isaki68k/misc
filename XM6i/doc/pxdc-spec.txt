pxdc の仕様書 (2014/05/14)

  XM6i の仮想デバイス Pluto-X による準仮想化(?)っぽい SCSI コントローラ


MB89352 との関係

	pxdc は準仮想化による高速化を目指したものだが、このままでは起動 HD に
	なることが出来ない。拡張 SCSI ボード同様に独自の ROM を用意するなど
	して仮に pxdc 下の HD から起動できたとしても、pxdc 非対応カーネル
	(OS) で起動するたびに SRAM の設定を変更しなければならなくなるので、
	これは避けたい。

	そこで、まったく通常どおりに MB89352 等から起動してきた後で、pxdc に
	アクセスして MB89352 の特定の SCSI ID デバイスだけを切り離して pxdc
	配下に置き換えるという方法を検討する。
	コントローラごとではなく、特定 SCSI ID ごとに切り替える方式なのは
	現行で pxdc が CD/MO を扱えない公算が高いため、まずは HD だけ pxdc で
	高速化しておき、CD/MO については従来どおり MB89352 エミュレーションで
	使用することを想定している。

	NetBSD で言えば、ブートローダがカーネルをロードするまでは MB89352 で
	行い、カーネルのデバイスプローブ中に spc より先に pxdc がプローブされ
	てこれ以降 pxdc を使うみたいなことを想定。


SCSI コマンド
	SCSI コマンド (CDB?) は CDB レジスタに書き込んで、コマンドレジスタに
	開始要求を出す感じ。

	サポートを予定しているコマンド:
	  $00: Test Drive Ready
	  $01: Rezero Unit
	  $03: Request Sense
	  $08: Read(6)
	  $0A: Write(6)
	  $12: Inquiry
	  $1A: Mode Sense
	  $25: Read Capacity
	  $28: Read(10)
	  $2A: Write(10)
	  $35: Synchronize Cache
	その他ゲスト OS から発行されたコマンドには対応するはず。


転送モード
	pxdc は PIO モードとバスマスタモードの2つの転送モードを持っており、
	SCSI コマンド開始レジスタで設定する。

	PIO モードは、pxdc のデータ転送レジスタへの読み書きを通じて行う方法。

	バスマスタモードは pxdc に転送開始アドレスと転送データ長を指定して、
	pxdc によって DMA 転送する方法。

	DMAC(HD63450) による DMA は、PIO モードを使用することで可能だが
	転送速度的にメリットはないと思う。


メモリマップ

	$eac500〜$eac5ff


レジスタ

	+$00.L シグネチャレジスタ (ReadOnly)
		pxdc シグネチャ。'DC01'

	+$04.B*8 ターゲットデバイスイネーブル/ステータス (Read/Write)
		8バイトあり、それぞれ ID=0 〜 7 に対応。

		読み込み時はターゲットデバイスの状態を示す。

		  %TTTT000E 
		   ||||   +- %1 なら pxdc、%0 なら MB89352 の制御下
		   ||||
		   ++++----- デバイスタイプ
		             %0000: 接続なし
		             %0001: HD
		             %0010: CD
		             %0011: MO
		             %1111: イニシエータ

		E が %1 ならこのターゲットデバイスが pxdc 制御下にあること
		を示す。%0 なら MB89352 の制御下にあるので pxdc からは
		アクセスできない。
		デバイスタイプは SCSI Inquiry コマンド等での種別情報とは
		無関係に XM6i のデバイスの状態を示している。

		書き込み時はターゲットデバイスの状態を変更する。

		  %xxxxxxxE
		          +- pxdc 配下に切り替え

		上位7ビットは書き込みは無視される。E に %1 を書き込むと
		ターゲットデバイスは MB89352 から切り離されて pxdc の制御下
		となる。E に %0 を書き込むとターゲットデバイスは MB89352 の
		制御下に戻る機能は予約であり未実装。したがって一度ターゲット
		デバイスの制御を pxdc に切り替えるとハードウェアリセットする
		までは、MB89352 に戻す方法はない。
		デバイスが存在しないか、pxdc がサポートしていないデバイスで
		あればこの操作は何も起こらない。
		現在のところ pxdc は SCSI HD のみサポートしている。
		書き込み後にターゲットデバイスステータスレジスタの E ビット
		を読んで切り替えが出来たか確認できる。

	+$0C.B ドライブ選択レジスタ (Read/Write)
		下位3ビットにアクセスする SCSI ID を指定する。
		読み出しは現在選択されている ID を返す。
		リセット時は 0 に初期化される。

		  %00000DDD
		        +++- SCSI ID

	+$0D.B SCSI コマンド開始レジスタ (WriteOnly)

		  %M00000SS
		   |     ++- コマンド開始
		   |         %00: 6バイトCDBコマンド開始
		   |         %01: 10バイトCDBコマンド開始
		   |         %10: 12バイトCDBコマンド開始
		   |         %11: (予約)
		   |
		   +-------- 転送モード
		             %0: PIO モード
		             %1: バスマスタモード

		コマンド開始は、あらかじめ CDB に書き込まれた SCSI コマンド
		の処理を開始する。

	+$0E.B ステータスレジスタ	(Read/Write)
		現在のフェーズとエラー状態を表す。
		上位3ビットはエラーを表し、エラーが起きると該当するビットが
		%1 になる。エラービットをクリアするには該当ビットに %0 を
		書き込む。
		下位2ビットは現在の SCSI フェーズを表す。

		  %BDC000SS
		   |||   ++- フェーズ (ReadOnly)
		   |||
		   ||+------ コマンド開始エラー
		   |+------- ドライブ選択エラー
		   +-------- バスマスタエラー


		コマンド開始エラー
			コマンド開始レジスタの内容が不正。

		ドライブ選択エラー
			ドライブ選択レジスタの内容が不正。
			ターゲットが接続されていない ID、あるいはイニシエータ
			の ID が指定された場合。

		バスマスタエラー
			バスマスタ転送でバスエラーが発生。

		フェーズ (ReadOnly)
			%00: バスフリーフェーズ
			%01: データインフェーズ
			%10: データアウトフェーズ
			%11: ステータスフェーズ

	+$0F.B SCSI ステータスレジスタ (ReadOnly)
		SCSI ステータスバイトが読み出せる。
		このレジスタをステータスフェーズで読み出すとバスフリーフェーズ
		に戻る。それ以外のフェーズで読み出しても内容は不定でフェーズも
		遷移しない。

	+$10.B*16 CDB レジスタ (Read/Write)
		CDB を書き込むバッファ。
		CDB をここに書き込んだ後コマンドレジスタに適切な長さの CDB
		コマンド開始を書き込むことで SCSI 要求を処理する。

		このレジスタは RAM であり、リセット時は 0xff で初期化される
		以外は pxdc コントローラがこのレジスタの値を変更することはない。

	+$20.L 転送バイト数レジスタ (ReadOnly)
		デバイスが転送を要求している残りバイト数。

	+$24.L アレイチェインテーブルレジスタ (Read/Write)
		バスマスタモードの場合のアレイチェインテーブルの開始アドレスを
		指定する。アドレスは物理アドレス。

	+$28.B PIO データ転送レジスタ (Read/Write)
		データ転送用のレジスタ。


アレイチェインテーブル

	バスマスタモードの CPU 側メモリは複数のブロックを指定することができる。
	1つのブロックは以下の構成になっている。

	  +$00.L メモリアドレス
	  +$04.L サイズ

	アレイチェインテーブルは、この8バイトブロックを任意の数だけ配列として
	連続して配置したものであり、終端はサイズフィールドが $0 のブロックで
	表す。

	例えば、$12000 番地から $2000 バイト、$20000 番地から $1000 バイトの
	2つのブロックに合計 $3000 バイトを転送する場合のアレイチェインテーブル
	は次のようになる。

	  +$00: $00012000 .. 1つ目のブロック
	  +$04: $00002000
	  +$08: $00020000 .. 2つ目のブロック
	  +$0C: $00001000
	  +$10: $xxxxxxxx .. 終端ブロック (アドレスフィールドの値は不問)
	  +$14: $00000000

その他
	バスマスタモードにおいて pxdc がメモリをアクセスするときは、内部で
	直接メモリをアクセスする。このとき、FC は扱われないが、スーパバイザ
	データアクセスと同じ扱いとなる。

(EOF)
