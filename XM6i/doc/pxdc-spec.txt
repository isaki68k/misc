pxdc の仕様書 (2014/05/10)

  XM6i の仮想デバイス Pluto-X による準仮想化(?)っぽい SCSI コントローラ


MB89352 との関係

	pxdc は準仮想化による高速化を目指したものだが、このままでは起動 HD に
	なることが出来ない。拡張 SCSI ボード同様に独自の ROM を用意するなど
	して仮に pxdc 下の HD から起動できたとしても、pxdc 非対応カーネル
	(OS) で起動するたびに SRAM の設定を変更しなければならなくなるので、
	これは避けたい。

	そこで、まったく通常どおりに MB89352 等から起動してきた後で、pxdc に
	アクセスして MB89352 の特定の SCSI ID デバイスだけを切り離して pxdc
	配下に置き換えるという方法を検討する。
	コントローラごとではなく、特定 SCSI ID ごとに切り替える方式なのは
	現行で pxdc が CD/MO を扱えない公算が高いため、まずは HD だけ pxdc で
	高速化しておき、CD/MO については従来どおり MB89352 エミュレーションで
	使用することを想定している。

	NetBSD で言えば、ブートローダがカーネルをロードするまでは MB89352 で
	行い、カーネルのデバイスプローブ中に spc より先に pxdc がプローブされ
	てこれ以降 pxdc を使うみたいなことを想定。


SCSI コマンド
	SCSI コマンド (CDB?) は CDB レジスタに書き込んで、コマンドレジスタに
	開始要求を出す感じ。

	サポートを予定しているコマンド:
	  $00: Test Drive Ready
	  $01: Rezero Unit
	  $03: Request Sense
	  $08: Read(6)
	  $0A: Write(6)
	  $12: Inquiry
	  $1A: Mode Sense
	  $25: Read Capacity
	  $28: Read(10)
	  $2A: Write(10)
	  $35: Synchronize Cache
	その他ゲスト OS から発行されたコマンドには対応するはず。

転送モード
	pxdc はウィンドウモード(仮称)と pxdma モードの2つの転送モードを持って
	おり、モード選択レジスタ(?)で設定する。

	ウィンドウモードは、pxdc が 2048 バイトのデータウィンドウを持っており
	ここへの読み書きを通じて行う方法。

	DMA モードは pxdc に転送開始アドレスと転送データ長を指定して、
	pxdma によって DMA 転送する方法。pxdma は Pluto-X が提供する準仮想化
	DMA コントローラ。

	DMAC(HD68450) による DMA モードって要る?


メモリマップ

	$eac700〜$eac7ff (予定) コントロールブロック
	$eac800〜$eacfff (予定) データウィンドウ


レジスタ

	いずれもアドレス未定。

	シグネチャレジスタ (Word? or Long?、ReadOnly)
		pxdc シグネチャ。このデバイスのバージョンとかを含むかも。

	イネーブル (Byte?、R/W)
		pxdc イネーブルポート。
		SCSI ID 0〜7(6?) のうちどの ID を pxdc で使用するかを指定
		する。レジスタの値はリセット時は 0x00 で、以降の書き込みは
		元の値との論理和(OR)になり、ビットをクリアすることは出来ない。
		読み出すと現在の値が読み出せる (副作用はない)。

		  %00000001: ID 0
		  %00000010: ID 1
		  %00000100: ID 2
		  %00001000: ID 3
		  %00010000: ID 4
		  %00100000: ID 5
		  %01000000: ID 6
		  %10000000: ID 7 (?)

		ここで指定した ID の SCSI デバイスは MB89352 エミュレーション
		の制御から外れ pxdc の制御下となる。一度こちらの制御下になった
		デバイスを元の MB89352 デバイスに戻すことは出来ない。

		ハードウェアリセットで初期状態に戻り、pxdc はすべての
		ターゲットを手放す (MB89352 のデバイスに戻る)。

		TODO: MB89352 側で空いてた ID だとどうするか?
		      こっちに制御を移してビットは立てるがデバイス NULL の
		      ままか、制御を移さずビットをクリアしたままにするか。

	ドライブ選択レジスタ (Byte?、R/W)
		下位3ビットにアクセスする SCSI ID を指定する。
		読み出しは現在選択されている ID を返す。
		リセット時は 0 に初期化?

	モード選択レジスタ (Byte?、R/W)
		転送モードの選択?
		DMAモードかウィンドウモード(?)か。

	コマンドレジスタ	(size?、Read?/Write)
		o コマンド開始ビット?
			CDB を書き込んだ後でイネーブルにすると処理を開始する。
			あるいはセットした CDB の長さを書き込むと処理を開始?
			どっちみち CDB 長をどこかにセットしないといけないし。

	ステータスレジスタ	(size?、ReadOnly)
		o 転送完了かエラーかを示すビット?
		o エラー原因を複数ビットで表すとか必要かも?

	SCSI ステータスレジスタ (Byte、ReadOnly)
		とかいる?

	CDB バッファ? (12Byte、WriteOnly)
		CDB を書き込むバッファ。
		CDB (6、10、12バイト) をここに書き込んで、どこか(未定)に長さを
		セットし、たぶんコマンドレジスタに開始コマンドを書き込むと、
		SCSI 要求を処理する。

		応答は、Pluto-X DMA か pxdc ウィンドウ (モード選択による) から
		読み出す。

	データ転送ウィンドウ (2048Byte、Read/Write)
		ウィンドウモードの場合のデータ転送ウィンドウ。
		書き込み時はここに最大 2048バイトのデータを書き込んでから
		コマンドレジスタに開始コマンドを書き込むとかになるはず。
		読み込み時はここに最大 2048バイトのデータが用意されるので
		読み取ったらコマンドレジスタに何か書き込んで処理の完了を
		通知する。

		書き込みが 2048バイト以上の場合は、2048バイト書き込んで、
		コマンドレジスタに「次へ」みたいなコマンドを投げるとか。
		読み込み時も同様。

	転送開始アドレスレジスタ (Long、Read?/Write)
		pxdma モードの場合の CPU 側メモリの転送開始アドレスを指定する。
		アドレスは物理アドレス?

	転送データ長レジスタ (Long、Read?/Write)
		pxdma モードの場合の転送データ長を指定する。
		単位はバイト。

(EOF)
